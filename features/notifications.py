import logging

# ë¡œê±° ì„¤ì •
logger = logging.getLogger("NotificationLogger")
logger.setLevel(logging.DEBUG)

from datetime import datetime, timezone, timedelta
from typing import Dict, Any, List

# í•œêµ­ ì‹œê°„ëŒ€ ì„¤ì •
KST = timezone(timedelta(hours=9))

# ì•Œë¦¼ì„ ë°›ì„ ë°© ëª©ë¡ ì„¤ì •
NOTIFICATION_ROOMS = {
    "stroking": ["ëª°ë£¨ ì•„ì¹´ì´ë¸Œ PGR"],
    "galaxy": ["ëª°ë£¨ ì•„ì¹´ì´ë¸Œ PGR"],
    "birthday": ["ëª°ë£¨ ì•„ì¹´ì´ë¸Œ PGR"],
    "shop": ["ëª°ë£¨ ì•„ì¹´ì´ë¸Œ PGR"]
}

# ìºë¦­í„° ìƒì¼ ë°ì´í„° (ì›”, ì¼, ì´ë¦„)
CHARACTER_BIRTHDAYS = [
    (1, 2, "í˜¸ì‹œë…¸"),
    (1, 3, "ì‚¬ì•¼"),
    (1, 3, "í•˜ë‚˜ì½”"),
    (1, 5, "ì½”íƒ€ë§ˆ"),
    (1, 6, "ì„¸ë¦¬ë‚˜"),
    (1, 7, "ë¯¸ì•¼ì½”"),
    (1, 8, "íˆìš”ë¦¬"),
    (1, 13, "ë¯¸ì‚¬í‚¤"),
    (1, 20, "ì•„ì¸ ì½”"),
    (1, 22, "ì‹œêµ¬ë ˆ"),
    (1, 30, "ì•„ì´ë¦¬"),
    (2, 2, "ì¹´ë¦°"),
    (2, 3, "ì¸ ë°”í‚¤"),
    (2, 5, "ìŠŒ"),
    (2, 14, "ì½”ìœ í‚¤"),
    (2, 19, "íˆë‚˜"),
    (2, 19, "í‚¤ì‚¬í‚¤"),
    (2, 20, "ë…¸ë„ì¹´"),
    (2, 22, "ë¯¸ì¹˜ë£¨"),
    (2, 24, "í‚¤ë¼ë¼"),
    (3, 1, "í•˜ë£¨ë‚˜"),
    (3, 3, "ë ˆì´ì£ "),
    (3, 5, "ë£¨ë¯¸"),
    (3, 12, "ì•„ë£¨"),
    (3, 14, "ìœ ìš°ì¹´"),
    (3, 15, "ë¯¸ëª¨ë¦¬"),
    (3, 17, "ì¹´ìš”ì½”"),
    (3, 19, "ë§ˆì½”í† "),
    (3, 24, "ì•„ìŠ¤ë‚˜"),
    (3, 25, "ì•„ë¦¬ìŠ¤"),
    (4, 1, "ì•„ì¹´ë„¤"),
    (4, 2, "íˆë¹„í‚¤"),
    (4, 3, "ì™€ì¹´ëª¨"),
    (4, 5, "ì¸ ì¿ ìš”"),
    (4, 7, "ì„¸ë‚˜"),
    (4, 9, "ì‚¬í‚¤"),
    (4, 10, "ì‚¬ì¸ í‚¤"),
    (4, 13, "ë…¸ì•„"),
    (4, 14, "ì´ë¶€í‚¤"),
    (4, 16, "ì½”í•˜ë£¨"),
    (4, 19, "í•˜ë ˆ"),
    (4, 23, "ìš°ì´"),
    (4, 25, "ë©”êµ¬"),
    (4, 26, "ì¹˜íˆë¡œ"),
    (4, 30, "í›„ìš°ì¹´"),
    (5, 1, "ì—ì´ë¯¸"),
    (5, 2, "ë¯¸ì‚¬ì¹´ ë¯¸ì½”í† "),
    (5, 8, "ë¯¸ì¹´"),
    (5, 11, "ì´ì¦ˆë¯¸"),
    (5, 12, "í•˜ë‚˜ì—"),
    (5, 13, "í•˜ë£¨ì¹´"),
    (5, 16, "ì‹œë¡œì½”"),
    (5, 16, "ì‹œë¡œì½”*í…ŒëŸ¬"),
    (5, 17, "íˆë‚˜íƒ€"),
    (5, 24, "ì¹´ìŠ¤ë¯¸"),
    (5, 31, "ë ˆì´ì‚¬"),
    (6, 1, "ì½”ì½”ë‚˜"),
    (6, 5, "ë§ˆì‹œë¡œ"),
    (6, 16, "ìœ ì¹´ë¦¬"),
    (6, 24, "ì¸ ë£¨ê¸°"),
    (6, 25, "ì„¸ë¦¬ì¹´"),
    (7, 1, "ìš°ë¯¸ì¹´"),
    (7, 4, "ë‚˜ê¸°ì‚¬"),
    (7, 7, "ì‹œì¦ˆì½”"),
    (7, 9, "ì¹´ì—ë°"),
    (7, 12, "ë¯¸ìœ "),
    (7, 13, "ì¹˜ì„¸"),
    (7, 14, "ë¯¸ë…¸ë¦¬"),
    (7, 23, "ë Œê²Œ"),
    (7, 29, "ë¬´ì¸ í‚¤"),
    (8, 1, "ë§ˆí‚¤"),
    (8, 5, "ì¹´ì¦ˆì‚¬"),
    (8, 7, "ëª¨ë¯¸ì§€"),
    (8, 8, "í‚¤ì¿„"),
    (8, 12, "ìœ ì¦ˆ"),
    (8, 16, "í† í‚¤"),
    (8, 17, "ë„¤ë£¨"),
    (8, 20, "ìŠ¤ë¯¸ë ˆ"),
    (8, 22, "ì¹˜ë‚˜ì¸ "),
    (8, 29, "ìš”ì‹œë¯¸"),
    (8, 31, "ìŠ¤ì¦ˆë¯¸"),
    (8, 31, "í•˜ì¸ ë„¤ ë¯¸ì¿ "),
    (9, 1, "ë…¸ë…¸ë¯¸"),
    (9, 3, "ì‚¬ì˜¤ë¦¬"),
    (9, 7, "ì¹¸ë‚˜"),
    (9, 9, "ë¯¸ë‚˜"),
    (9, 12, "ë§ˆë¦¬"),
    (9, 13, "ëª¨ì—"),
    (9, 22, "ì¹˜ì•„í‚¤"),
    (10, 4, "ì‚¬ì¿ ë¼ì½”"),
    (10, 9, "ì¹´í˜¸"),
    (10, 20, "ì£¼ë¦¬"),
    (10, 21, "í›„ë¶€í‚¤"),
    (10, 22, "í‚¤ë¦¬ë…¸"),
    (10, 27, "ì²´ë¦¬ë…¸"),
    (11, 3, "í”¼ë‚˜"),
    (11, 4, "ë§ˆë¦¬ë‚˜"),
    (11, 8, "ì´ì˜¤ë¦¬"),
    (11, 10, "í† ëª¨ì—"),
    (11, 11, "ì´ì¹˜ì¹´"),
    (11, 12, "ì•„ì•¼ë„¤"),
    (11, 13, "ìš°íƒ€í•˜"),
    (11, 16, "ì´ë¡œí•˜"),
    (11, 23, "ë¯¸ë„¤"),
    (11, 27, "íˆí›„ë¯¸"),
    (11, 30, "ì‹œë¯¸ì½”"),
    (12, 4, "ë‚˜ì¸ "),
    (12, 8, "ë¯¸ë„ë¦¬"),
    (12, 8, "ëª¨ëª¨ì´"),
    (12, 9, "ì•„ì¹´ë¦¬"),
    (12, 10, "íˆë§ˆë¦¬"),
    (12, 12, "í•˜ìŠ¤ë¯¸"),
    (12, 16, "ì´ì¦ˆë‚˜"),
    (12, 21, "ë©”ë£¨"),
    (12, 22, "ì•„ì½”"),
    (12, 26, "ì•„ì¦ˆì‚¬"),
    (12, 27, "ì¤€ì½”"),
    (12, 31, "ì½”í† ë¦¬")

]

async def send_notification(message: str, room: str) -> Dict[str, Any]:
    """
    ì§€ì •ëœ ë°©ì— ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” í•¨ìˆ˜
    ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ë´‡ APIë¥¼ í†µí•´ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•´ì•¼ í•¨
    """
    try:
        # ì—¬ê¸°ì— ì‹¤ì œ ë©”ì‹œì§€ ì „ì†¡ ë¡œì§ êµ¬í˜„
        # ì˜ˆ: ì¹´ì¹´ì˜¤í†¡ ë´‡ API í˜¸ì¶œ ë“±
        return {
            "status": "success",
            "message": message,
            "room": room,
            "timestamp": datetime.now(KST).isoformat()
        }
    except Exception as e:
        return {
            "status": "error",
            "error": str(e)
        }

async def check_stroking_time(rooms: list = None) -> str:
    """ì“°ë‹¤ë“¬ê¸° ì•Œë¦¼ í™•ì¸"""
    try:
        now = datetime.now()
        next_time = now.replace(hour=19, minute=0, second=0, microsecond=0)
        
        if now.hour >= 19:
            next_time += timedelta(days=1)
            
        time_left = next_time - now
        hours = time_left.seconds // 3600
        minutes = (time_left.seconds % 3600) // 60
        
        if hours > 0:
            return f"ì„ ìƒë‹˜! ë‹¤ìŒ ì“°ë‹¤ë“¬ê¸°ê¹Œì§€ {hours}ì‹œê°„ {minutes}ë¶„ ë‚¨ì•˜ì–´ìš”~"
        else:
            return f"ì„ ìƒë‹˜! ë‹¤ìŒ ì“°ë‹¤ë“¬ê¸°ê¹Œì§€ {minutes}ë¶„ ë‚¨ì•˜ì–´ìš”~"
            
    except Exception as e:
        logger.error(f"ì“°ë‹¤ë“¬ê¸° ì‹œê°„ í™•ì¸ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return "ì£„ì†¡í•´ìš” ì„ ìƒë‹˜... ì“°ë‹¤ë“¬ê¸° ì‹œê°„ì„ í™•ì¸í•˜ë‹¤ê°€ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”."

async def check_galaxy_coupon(rooms: List[str]):
    """
    ë§¤ì£¼ ì›”/ê¸ˆ 10:58ì— ê²”ëŸ­ì‹œ ì¿ í° í™•ì¸ ì•Œë¦¼
    """
    message = "ì„ ìƒë‹˜ ê²”ëŸ­ì‹œ ì¿ í° í™•ì¸í•˜ì„¸ìš”! "
    for room in rooms:
        await send_notification(message, room)

async def check_character_birthday(rooms: List[str]) -> str:
    """
    ì˜¤ëŠ˜ì´ ìƒì¼ì¸ ìºë¦­í„° í™•ì¸ ë° ì•Œë¦¼
    """
    now = datetime.now(KST)
    today_month = now.month
    today_day = now.day
    
    birthday_characters = [
        name for month, day, name in CHARACTER_BIRTHDAYS
        if month == today_month and day == today_day
    ]
    
    if birthday_characters:
        characters = ", ".join(birthday_characters)
        message = f"ì„ ìƒë‹˜! ì˜¤ëŠ˜ì€ {characters} ì˜ ìƒì¼ì´ì—ìš”! ì¶•í•˜í•´ì£¼ì„¸ìš”~ ğŸ‚"
        # ì•Œë¦¼ ì „ì†¡
        for room in rooms:
            await send_notification(message, room)
        return message
    else:
        return "ì„ ìƒë‹˜, ì˜¤ëŠ˜ì€ ìƒì¼ì¸ í•™ìƒì´ ì—†ë„¤ìš”!"

async def check_shop_reset():
    """ë§¤ì›” ë§ˆì§€ë§‰ ë‚  ìƒì  ì´ˆê¸°í™” ì•Œë¦¼"""
    try:
        current_time = datetime.now(KST)
        # ë‹¤ìŒ ë‚ ì´ ë‹¤ìŒ ë‹¬ì˜ 1ì¼ì¸ì§€ í™•ì¸
        next_day = current_time + timedelta(days=1)
        
        if next_day.day == 1:  # ì˜¤ëŠ˜ì´ ì´ë²ˆ ë‹¬ì˜ ë§ˆì§€ë§‰ ë‚ 
            message = (
                "ğŸ“¢ ì„ ìƒë‹˜! ì˜¤ëŠ˜ì€ ì´ë²ˆ ë‹¬ì˜ ë§ˆì§€ë§‰ ë‚ ì…ë‹ˆë‹¤!\n\n"
                "ğŸª ìƒì  ì´ˆê¸°í™” ì „ í™•ì¸í•˜ì‹¤ ê²ƒ:\n"
                "- ì´ë ¥ì „/ëŒ€ê²°ì „ ìƒì \n"
                "- ì¢…í•©ì „ìˆ ì‹œí—˜ ìƒì \n"
                "- ìˆ™ë ¨ì¦ì„œ ìƒì \n"
                "ìƒì  ì´ˆê¸°í™” ì „ì— ëª¨ë“  ì¬í™”ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ìŠì§€ ë§ˆì„¸ìš”!"
            )
            
            # ì•Œë¦¼ ì „ì†¡
            for room in NOTIFICATION_ROOMS["shop"]:
                await send_notification(room, message)
                
    except Exception as e:
        logger.error(f"ìƒì  ì´ˆê¸°í™” ì•Œë¦¼ ì˜¤ë¥˜: {str(e)}") 